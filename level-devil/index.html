<!DOCTYPE html>
<html>
<head>
    <title>ðŸ˜ˆ Level Devil ðŸ˜ˆ</title>
    <link rel="icon" type="image/x-icon" href="https://math.hws.edu/favicon.ico">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>
    <iframe id="gameFrame" src="https://leveldevil-unblocked.github.io/" frameborder="0" allowfullscreen webkitallowfullscreen mozallowfullscreen allow="fullscreen *; autoplay; gamepad"></iframe>

    <script>
        const iframe = document.getElementById('gameFrame');
        const ALLOWED_URLS = [
            'https://leveldevil-unblocked.github.io/',
            'https://leveldevil-unblocked.github.io/#'
        ];
        const BLOCKED_KEYWORDS = ['securly', 'blocked', 'access denied', 'restricted'];
        let isReloading = false;
        let hasLoadedSuccessfully = false;
        let checkInterval;

        function normalizeUrl(url) {
            if (!url) return '';
            // Remove trailing slash for comparison, handle hash variations
            return url.replace(/\/+$/, '').replace(/#$/, '');
        }

        function isAllowedUrl(url) {
            if (!url) return false;
            const normalized = normalizeUrl(url);
            return ALLOWED_URLS.some(allowed => {
                const normalizedAllowed = normalizeUrl(allowed);
                return normalized === normalizedAllowed || 
                       normalized === normalizedAllowed + '#' ||
                       url.startsWith(allowed.replace(/\/$/, ''));
            });
        }

        function isBlockedUrl(url) {
            if (!url) return false;
            const lowerUrl = url.toLowerCase();
            return BLOCKED_KEYWORDS.some(keyword => lowerUrl.includes(keyword));
        }

        function triggerReload() {
            if (isReloading) return;
            isReloading = true;
            clearInterval(checkInterval);
            console.log('Reloading due to blocked/invalid URL detected');
            setTimeout(() => location.reload(), 1500);
        }

        function checkIframeStatus() {
            if (isReloading || !hasLoadedSuccessfully) return;
            
            try {
                const currentUrl = iframe.contentWindow.location.href;
                
                // If we can read the URL and it's not allowed, reload
                if (!isAllowedUrl(currentUrl)) {
                    console.log('Invalid URL detected:', currentUrl);
                    triggerReload();
                    return;
                }
                
                // Check for blocked content in body
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc && iframeDoc.body) {
                    const bodyText = iframeDoc.body.innerText.toLowerCase();
                    const hasBlockedContent = BLOCKED_KEYWORDS.some(keyword => bodyText.includes(keyword));
                    
                    if (hasBlockedContent) {
                        console.log('Blocked content detected in body');
                        triggerReload();
                        return;
                    }
                }
                
            } catch (e) {
                // Cross-origin error means we're on a different domain (blocked)
                console.log('Cross-origin error - likely blocked');
                triggerReload();
            }
        }

        // Wait for iframe to fully load before starting checks
        iframe.addEventListener('load', () => {
            console.log('Iframe load event fired');
            
            // Give it a moment to settle, then verify
            setTimeout(() => {
                try {
                    const currentUrl = iframe.contentWindow.location.href;
                    console.log('Checking loaded URL:', currentUrl);
                    
                    if (!isAllowedUrl(currentUrl)) {
                        console.log('Initial load check failed - URL not allowed');
                        triggerReload();
                        return;
                    }
                    
                    // Mark as successfully loaded
                    hasLoadedSuccessfully = true;
                    console.log('Initial load successful, starting monitoring');
                    
                    // Start periodic checking only after confirmed good load
                    checkInterval = setInterval(checkIframeStatus, 1000);
                    
                } catch (e) {
                    // Can't access URL - cross origin blocked
                    console.log('Initial load check failed - cross origin');
                    triggerReload();
                }
            }, 2000); // Wait 2 seconds after load event for page to settle
        });

        // Monitor page title for blocking indicators
        const titleObserver = new MutationObserver(() => {
            if (isReloading) return;
            
            const title = document.title.toLowerCase();
            if (BLOCKED_KEYWORDS.some(keyword => title.includes(keyword))) {
                console.log('Blocked keyword found in title');
                triggerReload();
            }
        });
        
        titleObserver.observe(document.querySelector('title'), {
            childList: true,
            subtree: true,
            characterData: true
        });

        // Safety timeout: if no successful load after 15 seconds, reload
        setTimeout(() => {
            if (!hasLoadedSuccessfully && !isReloading) {
                console.log('Safety timeout - no successful load detected');
                triggerReload();
            }
        }, 15000);
    </script>
</body>
</html>
