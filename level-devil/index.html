<!DOCTYPE html>
<html>
<head>
    <title>ðŸ˜ˆ Level Devil ðŸ˜ˆ</title>
    <link rel="icon" type="image/x-icon" href="https://math.hws.edu/favicon.ico">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
    </style>
</head>
<body>
    <iframe id="gameFrame" src="https://leveldevil-unblocked.github.io/" frameborder="0" allowfullscreen webkitallowfullscreen mozallowfullscreen allow="fullscreen *; autoplay; gamepad"></iframe>

    <script>
        const iframe = document.getElementById('gameFrame');
        const BASE_URL = 'https://leveldevil-unblocked.github.io';
        const BLOCKED_KEYWORDS = ['securly', 'blocked', 'access denied', 'restricted', 'goguardian', 'iboss'];
        let isReloading = false;
        let confirmedGoodLoad = false;
        let lastGoodUrl = null;
        let checkInterval;
        let gracePeriod = true;

        function normalizeUrl(url) {
            if (!url) return '';
            // Remove protocol, www, and trailing slashes for comparison
            return url.replace(/^https?:\/\//, '')
                     .replace(/^www\./, '')
                     .replace(/\/+$/, '')
                     .toLowerCase();
        }

        function isAllowedUrl(url) {
            if (!url) return false;
            const normalized = normalizeUrl(url);
            const baseNormalized = normalizeUrl(BASE_URL);
            
            // Allow base URL and any paths/hash on it
            return normalized === baseNormalized || 
                   normalized.startsWith(baseNormalized + '/') ||
                   normalized.startsWith(baseNormalized + '#');
        }

        function triggerReload(reason) {
            if (isReloading) return;
            isReloading = true;
            clearInterval(checkInterval);
            console.log('Reloading because:', reason);
            setTimeout(() => location.reload(), 1000);
        }

        function getIframeUrl() {
            try {
                return iframe.contentWindow.location.href;
            } catch (e) {
                return 'CROSS_ORIGIN';
            }
        }

        function checkStatus() {
            if (isReloading) return;
            
            const currentUrl = getIframeUrl();
            
            // If we can't access URL (cross-origin), it might be blocked
            if (currentUrl === 'CROSS_ORIGIN') {
                // Only reload if we previously had a good load and now can't access
                if (confirmedGoodLoad && lastGoodUrl) {
                    triggerReload('Lost access to iframe (cross-origin) after good load');
                }
                return;
            }

            // Update last known good URL
            if (isAllowedUrl(currentUrl)) {
                lastGoodUrl = currentUrl;
                if (!confirmedGoodLoad) {
                    confirmedGoodLoad = true;
                    gracePeriod = false;
                    console.log('Confirmed good load on:', currentUrl);
                }
                return;
            }

            // URL is not allowed
            if (!gracePeriod && confirmedGoodLoad) {
                triggerReload('Navigated to disallowed URL: ' + currentUrl);
            }
        }

        // Handle load event
        iframe.addEventListener('load', () => {
            console.log('Iframe load event');
            
            // Wait for iframe to settle
            setTimeout(() => {
                const url = getIframeUrl();
                console.log('Checking URL after load:', url);
                
                if (url !== 'CROSS_ORIGIN' && isAllowedUrl(url)) {
                    confirmedGoodLoad = true;
                    lastGoodUrl = url;
                    gracePeriod = false;
                    console.log('Initial load confirmed good');
                    
                    // Start monitoring
                    if (!checkInterval) {
                        checkInterval = setInterval(checkStatus, 2000);
                    }
                } else if (url === 'CROSS_ORIGIN') {
                    // Might still be loading, give it more time
                    console.log('Cross-origin on initial load, waiting...');
                } else {
                    triggerReload('Initial load to bad URL: ' + url);
                }
            }, 3000); // 3 second grace period for initial load
        });

        // Monitor title changes
        const titleObserver = new MutationObserver(() => {
            const title = document.title.toLowerCase();
            if (BLOCKED_KEYWORDS.some(k => title.includes(k))) {
                triggerReload('Blocked keyword in title');
            }
        });
        
        titleObserver.observe(document.querySelector('title'), {
            childList: true,
            subtree: true,
            characterData: true
        });

        // End grace period after 10 seconds regardless
        setTimeout(() => {
            gracePeriod = false;
            if (!confirmedGoodLoad && !isReloading) {
                triggerReload('Never confirmed good load within grace period');
            }
        }, 10000);

        // Handle messages from iframe (some games postMessage)
        window.addEventListener('message', (e) => {
            // If we get messages, iframe is likely working
            if (!confirmedGoodLoad && isAllowedUrl(e.origin)) {
                console.log('Received message from allowed origin:', e.origin);
                confirmedGoodLoad = true;
                gracePeriod = false;
            }
        });
    </script>
</body>
</html>
