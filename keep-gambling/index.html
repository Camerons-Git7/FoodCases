<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEEP GAMBLING - 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Permanent+Marker&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Black Ops One', 'Impact', sans-serif;
            overflow: hidden;
            cursor: none;
            user-select: none;
        }

        #game {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
        }

        #ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.8);
        }

        #crosshair::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: #ff006e;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            box-shadow: 0 0 10px #ff006e;
        }

        #stats {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.95);
            border: 4px solid #ff006e;
            padding: 20px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
        }

        .stat-debt { 
            color: #ff3333; 
            margin: 8px 0; 
            text-shadow: 0 0 10px rgba(255, 51, 51, 0.8);
            font-size: 28px;
        }
        .stat-cash { 
            color: #00ff41; 
            margin: 8px 0; 
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.8);
            font-size: 28px;
        }
        .stat-bpm { 
            color: #ffbe0b; 
            margin: 8px 0; 
            font-size: 36px;
            text-shadow: 0 0 15px rgba(255, 190, 11, 0.8);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        #interaction {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff006e, #ff006eaa);
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 28px;
            font-weight: bold;
            border: 4px solid #fff;
            display: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.8);
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        #inventory {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.95);
            border: 3px solid #ffbe0b;
            padding: 20px;
            border-radius: 15px;
            font-size: 22px;
            box-shadow: 0 0 20px rgba(255, 190, 11, 0.5);
        }

        .ticket-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffbe0b, #ff006e);
            color: #000;
            padding: 8px 20px;
            border-radius: 25px;
            margin-left: 15px;
            font-weight: bold;
            font-size: 24px;
            box-shadow: 0 0 15px rgba(255, 190, 11, 0.8);
        }

        #heartMonitor {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 250px;
            height: 120px;
            background: rgba(0,0,0,0.95);
            border: 4px solid #ff006e;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.5);
        }

        #heartCanvas {
            width: 100%;
            height: 70px;
        }

        .bpm-text {
            text-align: center;
            color: #ff006e;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 0, 110, 0.8);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.98);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
        }

        .ticket-container {
            width: 800px;
            height: 600px;
            background: linear-gradient(135deg, #d4af37 0%, #f4e5c2 30%, #d4af37 50%, #f4e5c2 70%, #d4af37 100%);
            border: 8px solid #8b7355;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 60px rgba(255,0,110,0.8), inset 0 0 100px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .ticket-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.1) 10px,
                rgba(255,255,255,0.1) 20px
            );
            animation: holographic 3s linear infinite;
            pointer-events: none;
        }

        @keyframes holographic {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .ticket-header {
            text-align: center;
            color: #2c1810;
            font-size: 42px;
            font-weight: bold;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.5);
            font-family: 'Permanent Marker', cursive;
            position: relative;
            z-index: 1;
        }

        .luck-indicator {
            text-align: center;
            color: #ff006e;
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255,0,110,0.8);
        }

        .scratch-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            height: 350px;
            position: relative;
            z-index: 1;
        }

        .scratch-box {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 50%, #c0c0c0 100%);
            border: 5px solid #666;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
        }

        .scratch-cover {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(45deg, #777, #777 15px, #999 15px, #999 30px),
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, transparent 50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #444;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            cursor: crosshair;
            touch-action: none;
        }

        .scratch-cover::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.4) 50%, transparent 60%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .scratch-box.scratched .scratch-cover {
            opacity: 0;
            transition: opacity 0.5s;
        }

        .scratch-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 56px;
            font-weight: bold;
            color: #000;
            display: none;
            text-shadow: 2px 2px 4px rgba(255,255,255,0.8);
            font-family: 'Black Ops One', sans-serif;
        }

        .scratch-box.scratched .scratch-value {
            display: block;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .slots-container {
            width: 900px;
            height: 500px;
            background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #1a0a2e 100%);
            border: 8px solid #ffbe0b;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 0 60px rgba(255,190,11,0.6);
        }

        .slots-display {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
            background: #000;
            padding: 30px;
            border-radius: 15px;
            border: 4px solid #333;
        }

        .slot-reel {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #fff 0%, #ddd 100%);
            border: 5px solid #ff006e;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            overflow: hidden;
            position: relative;
        }

        .slot-reel.spinning {
            animation: slotSpin 0.1s infinite;
        }

        @keyframes slotSpin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }

        .case-container {
            width: 900px;
            height: 450px;
            background: #0a0a0a;
            border: 6px solid #ffbe0b;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(255,190,11,0.5);
        }

        .case-roulette {
            display: flex;
            gap: 15px;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translateY(-50%);
            transition: left 4s cubic-bezier(0.1, 0.7, 0.1, 1);
        }

        .case-item {
            min-width: 180px;
            height: 140px;
            border: 4px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            text-align: center;
            background: #222;
            border-radius: 10px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .case-item.common { background: linear-gradient(135deg, #666, #888); border-color: #aaa; }
        .case-item.uncommon { background: linear-gradient(135deg, #4a9, #5cb); border-color: #5cb; }
        .case-item.rare { background: linear-gradient(135deg, #49a, #5bf); border-color: #5bf; }
        .case-item.epic { background: linear-gradient(135deg, #a4a, #c6c); border-color: #c6c; }
        .case-item.legendary { 
            background: linear-gradient(135deg, #fa4, #fc6); 
            border-color: #fc6; 
            box-shadow: 0 0 30px #fa4, inset 0 0 30px rgba(255,255,255,0.3);
            animation: legendaryPulse 1s infinite;
        }

        @keyframes legendaryPulse {
            0%, 100% { box-shadow: 0 0 30px #fa4; }
            50% { box-shadow: 0 0 60px #fa4, 0 0 100px #fc6; }
        }

        .case-selector {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(180deg, #ff006e, #ffbe0b);
            transform: translateX(-50%);
            z-index: 10;
            box-shadow: 0 0 30px #ff006e;
        }

        .case-btn, .slots-btn {
            margin-top: 30px;
            padding: 25px 70px;
            font-size: 28px;
            background: linear-gradient(135deg, #ff006e, #ffbe0b);
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 15px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 0 30px rgba(255,0,110,0.6);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .case-btn:hover, .slots-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(255,0,110,0.8);
        }

        .close-btn {
            margin-top: 30px;
            padding: 20px 50px;
            background: #333;
            border: 3px solid #666;
            color: #fff;
            cursor: pointer;
            border-radius: 15px;
            font-size: 22px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #444;
            border-color: #888;
        }

        #overdoseScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ff0000;
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            animation: flash 0.2s infinite;
        }

        @keyframes flash {
            0%, 100% { background: #ff0000; }
            50% { background: #aa0000; }
        }

        .overdose-title {
            font-size: 120px;
            color: #fff;
            text-shadow: 0 0 40px #000;
            animation: shake 0.3s infinite;
            font-family: 'Black Ops One', sans-serif;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-20px) rotate(-5deg); }
            75% { transform: translateX(20px) rotate(5deg); }
        }

        .overdose-subtitle {
            font-size: 40px;
            color: #fff;
            margin-top: 30px;
            text-shadow: 0 0 20px #000;
        }

        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a0a2e 0%, #000 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            cursor: default;
        }

        .game-title {
            font-size: 120px;
            background: linear-gradient(135deg, #ff006e, #ffbe0b, #ff006e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 40px;
            text-shadow: 0 0 60px rgba(255,0,110,0.5);
            animation: titlePulse 2s infinite;
            font-family: 'Black Ops One', sans-serif;
        }

        @keyframes titlePulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        .start-button {
            padding: 30px 100px;
            font-size: 42px;
            background: linear-gradient(135deg, #ff006e, #ffbe0b);
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            box-shadow: 0 0 40px rgba(255,0,110,0.8);
            transition: transform 0.3s, box-shadow 0.3s;
            font-family: 'Black Ops One', sans-serif;
            pointer-events: auto;
        }

        .start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 60px rgba(255,0,110,1);
        }

        .instructions {
            margin-top: 50px;
            color: #888;
            text-align: center;
            font-size: 22px;
            line-height: 2;
        }

        .key {
            display: inline-block;
            background: #222;
            padding: 8px 20px;
            border-radius: 8px;
            margin: 0 8px;
            border: 3px solid #ff006e;
            color: #ff006e;
            font-weight: bold;
        }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            max-width: 700px;
        }

        .shop-item-btn {
            padding: 25px;
            background: rgba(255,255,255,0.05);
            border: 4px solid #ffbe0b;
            border-radius: 15px;
            color: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .shop-item-btn:hover {
            background: rgba(255,190,11,0.2);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,190,11,0.4);
        }

        .shop-item-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .shop-item-name {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #ffbe0b;
            text-shadow: 0 0 10px rgba(255,190,11,0.5);
        }

        .shop-item-price {
            font-size: 24px;
            color: #00ff41;
            margin-bottom: 10px;
        }

        .shop-item-effect {
            font-size: 18px;
            color: #ff006e;
        }

        .win-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffbe0b, #ff006e);
            padding: 40px 80px;
            border-radius: 20px;
            font-size: 48px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 2001;
            display: none;
            animation: winPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 60px rgba(255,190,11,0.8);
        }

        @keyframes winPop {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        #deathTimer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: #fff;
            text-shadow: 0 0 20px #000;
        }

        .noise {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.05;
            z-index: 999;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body>
    <div class="noise"></div>
    
    <div id="startScreen">
        <div class="game-title">KEEP GAMBLING</div>
        <button class="start-button" onclick="startGame()">START GAMBLING</button>
        <div class="instructions">
            <p><span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span> to move</p>
            <p><span class="key">MOUSE</span> to look</p>
            <p><span class="key">E</span> to interact</p>
            <p><span class="key">SHIFT</span> to run (increases BPM)</p>
            <p><span class="key">HIGHER BPM = BETTER LUCK!</span></p>
        </div>
    </div>

    <div id="overdoseScreen">
        <div class="overdose-title">OVERDOSE!</div>
        <div class="overdose-subtitle">Heart rate critical! Respawning...</div>
        <div id="deathTimer">3</div>
    </div>

    <div class="win-popup" id="winPopup"></div>

    <div id="ticketModal" class="modal">
        <div class="ticket-container">
            <div class="ticket-header">üé∞ LUCKY SCRATCHER üé∞</div>
            <div class="luck-indicator" id="luckIndicator">LUCK MULTIPLIER: 1.0x</div>
            <div class="scratch-area" id="scratchArea"></div>
            <div style="text-align: center; margin-top: 20px; color: #5a4a3a; font-size: 20px; font-weight: bold;">
                DRAG MOUSE TO SCRATCH! Match 3 to win!
            </div>
            <button class="close-btn" onclick="closeTicket()">CLOSE</button>
        </div>
    </div>

    <div id="slotsModal" class="modal">
        <div class="slots-container">
            <h2 style="color: #ffbe0b; font-size: 42px; margin-bottom: 20px; text-align: center; text-shadow: 0 0 20px rgba(255,190,11,0.8);">üé∞ SLOTS üé∞</h2>
            <div class="luck-indicator" id="slotsLuck">LUCK MULTIPLIER: 1.0x</div>
            <div class="slots-display">
                <div class="slot-reel" id="slot1">‚ùì</div>
                <div class="slot-reel" id="slot2">‚ùì</div>
                <div class="slot-reel" id="slot3">‚ùì</div>
            </div>
            <div style="text-align: center;">
                <button class="slots-btn" onclick="spinSlots()">SPIN ($50)</button>
                <button class="close-btn" onclick="closeSlots()" style="margin-left: 20px;">LEAVE</button>
            </div>
        </div>
    </div>

    <div id="caseModal" class="modal">
        <div style="text-align: center;">
            <h2 style="color: #ffbe0b; font-size: 42px; margin-bottom: 20px; text-shadow: 0 0 20px rgba(255,190,11,0.8);">üì¶ WEAPON CASE üì¶</h2>
            <div class="luck-indicator" id="caseLuck">LUCK MULTIPLIER: 1.0x</div>
            <div class="case-container">
                <div class="case-roulette" id="caseRoulette"></div>
                <div class="case-selector"></div>
            </div>
            <button class="case-btn" onclick="spinCase()">OPEN CASE ($100)</button>
            <button class="close-btn" onclick="closeCase()" style="margin-left: 20px;">LEAVE</button>
        </div>
    </div>

    <div id="shopModal" class="modal">
        <div style="text-align: center;">
            <h2 style="color: #ffbe0b; font-size: 42px; margin-bottom: 40px; text-shadow: 0 0 20px rgba(255,190,11,0.8);">‚ö° ENERGY COOLER ‚ö°</h2>
            <div class="shop-grid" id="shopGrid"></div>
            <button class="close-btn" onclick="closeShop()">CLOSE</button>
        </div>
    </div>

    <div id="game" style="display: none;">
        <div id="canvas-container"></div>
        <div id="ui">
            <div id="crosshair"></div>
            <div id="stats">
                <div class="stat-debt">DEBT: $<span id="debtDisplay">10000</span></div>
                <div class="stat-cash">CASH: $<span id="cashDisplay">100</span></div>
                <div class="stat-bpm">‚ù§Ô∏è <span id="bpmDisplay">60</span> BPM</div>
            </div>
            <div id="heartMonitor">
                <canvas id="heartCanvas"></canvas>
                <div class="bpm-text" id="bpmText">60 BPM</div>
            </div>
            <div id="interaction">PRESS E TO INTERACT</div>
            <div id="inventory">
                TICKETS: <span class="ticket-badge" id="ticketDisplay">0</span>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer;
        let player = { x: 0, z: 0, rot: 0, height: 50 };
        let game = {
            cash: 100,
            debt: 10000,
            bpm: 60,
            tickets: 0,
            keys: {},
            nearObject: null,
            isRunning: false,
            isDead: false,
            luckMultiplier: 1
        };
        
        let walls = [];
        let interactables = [];
        let raycaster = new THREE.Raycaster();
        let isScratching = false;
        let scratchedBoxes = new Set();

        function startGame() {
            console.log("Starting game...");
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            
            try {
                init();
                console.log("Game initialized successfully");
            } catch (e) {
                console.error("Error initializing game:", e);
                alert("Error starting game: " + e.message);
            }
        }

        function init() {
            // Check if Three.js is loaded
            if (typeof THREE === 'undefined') {
                throw new Error("Three.js not loaded! Check your internet connection.");
            }

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 50, 400);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = player.height;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight.position.set(100, 200, 100);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Neon lights
            const pinkLight = new THREE.PointLight(0xff006e, 2, 300);
            pinkLight.position.set(-200, 80, 0);
            scene.add(pinkLight);

            const goldLight = new THREE.PointLight(0xffbe0b, 2, 300);
            goldLight.position.set(0, 80, 150);
            scene.add(goldLight);

            const blueLight = new THREE.PointLight(0x00ccff, 2, 300);
            blueLight.position.set(200, 80, -50);
            scene.add(blueLight);

            // Floor
            const floorGeo = new THREE.PlaneGeometry(2000, 2000);
            const floorMat = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a,
                roughness: 0.9,
                metalness: 0.1
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Ceiling
            const ceilGeo = new THREE.PlaneGeometry(2000, 2000);
            const ceilMat = new THREE.MeshStandardMaterial({ color: 0x050505 });
            const ceiling = new THREE.Mesh(ceilGeo, ceilMat);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.y = 100;
            scene.add(ceiling);

            buildStore();

            player.x = 0;
            player.z = 200;
            camera.position.x = player.x;
            camera.position.z = player.z;

            setupControls();
            animate();

            // Debt increases every 3 seconds
            setInterval(() => {
                if (!game.isDead) {
                    game.debt = Math.floor(game.debt * 1.02) + 5;
                    updateDisplay();
                    
                    if (game.debt > 50000) {
                        showMessage("DEBT COLLECTORS ARE COMING! GAMBLE FASTER!");
                    }
                }
            }, 3000);
        }

        function buildStore() {
            const wallMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
            const counterMat = new THREE.MeshStandardMaterial({ color: 0x4a3728 });
            const lottoMat = new THREE.MeshStandardMaterial({ 
                color: 0xff006e, 
                emissive: 0xff006e, 
                emissiveIntensity: 0.5 
            });
            const coolerMat = new THREE.MeshStandardMaterial({ 
                color: 0x00ccff, 
                emissive: 0x00ccff, 
                emissiveIntensity: 0.3 
            });
            const caseMat = new THREE.MeshStandardMaterial({ 
                color: 0xffbe0b, 
                emissive: 0xffbe0b, 
                emissiveIntensity: 0.4 
            });
            const slotsMat = new THREE.MeshStandardMaterial({ 
                color: 0x9400d3, 
                emissive: 0x9400d3, 
                emissiveIntensity: 0.3 
            });
            const pillMat = new THREE.MeshStandardMaterial({ color: 0xff006e });

            // Walls
            createWall(-400, 0, 800, 20, wallMat);
            createWall(400, 0, 800, 20, wallMat);
            createWall(0, -400, 20, 800, wallMat);
            createWall(0, 400, 20, 800, wallMat);

            // Counter
            createInteractable(-150, -100, 200, 60, 60, counterMat, 'counter', 'Counter');
            createInteractable(-50, -100, 60, 60, 60, counterMat, 'counter', 'Counter');
            createInteractable(50, -100, 60, 60, 60, counterMat, 'counter', 'Counter');

            // Lotto Machine
            createInteractable(-200, 0, 60, 80, 60, lottoMat, 'lotto', 'Lotto Machine');

            // Slots Machine
            createInteractable(-200, 150, 80, 100, 60, slotsMat, 'slots', 'Slots Machine');

            // Cooler
            createInteractable(200, -50, 80, 100, 60, coolerMat, 'cooler', 'Energy Cooler');
            
            // Case Table
            createInteractable(0, 150, 100, 60, 80, caseMat, 'case', 'Case Table');

            // Pills
            createInteractable(-100, -80, 30, 30, 30, pillMat, 'pills', 'Mystery Pills');

            // Shelves
            createWall(-300, 100, 20, 150, wallMat, 80);
            createWall(-300, -200, 20, 150, wallMat, 80);
        }

        function createWall(x, z, w, d, mat, h = 100) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, h/2, z);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            scene.add(mesh);
            walls.push(mesh);
            return mesh;
        }

        function createInteractable(x, z, w, h, d, mat, type, name) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, h/2, z);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.userData = { type: type, name: name, interactable: true };
            scene.add(mesh);
            interactables.push(mesh);
            return mesh;
        }

        function setupControls() {
            document.addEventListener('keydown', e => {
                game.keys[e.key.toLowerCase()] = true;
                if (e.key.toLowerCase() === 'e' && !game.isDead) tryInteract();
            });
            
            document.addEventListener('keyup', e => {
                game.keys[e.key.toLowerCase()] = false;
            });

            document.addEventListener('mousemove', e => {
                if (document.pointerLockElement === document.body) {
                    player.rot -= e.movementX * 0.002;
                    camera.rotation.y = player.rot;
                }
            });

            document.addEventListener('click', () => {
                if (!document.pointerLockElement && !game.isDead &&
                    document.getElementById('ticketModal').style.display !== 'flex' &&
                    document.getElementById('caseModal').style.display !== 'flex' &&
                    document.getElementById('shopModal').style.display !== 'flex' &&
                    document.getElementById('slotsModal').style.display !== 'flex') {
                    document.body.requestPointerLock();
                }
            });

            window.addEventListener('resize', () => {
                if (camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            if (game.isDead || 
                document.getElementById('ticketModal').style.display === 'flex' ||
                document.getElementById('caseModal').style.display === 'flex' ||
                document.getElementById('shopModal').style.display === 'flex' ||
                document.getElementById('slotsModal').style.display === 'flex') {
                if (renderer && scene && camera) renderer.render(scene, camera);
                return;
            }

            // Movement
            const speed = game.keys['shift'] ? 5 : 2.5;
            game.isRunning = game.keys['shift'];
            
            let dx = 0, dz = 0;
            
            if (game.keys['w']) {
                dx -= Math.sin(player.rot) * speed;
                dz -= Math.cos(player.rot) * speed;
            }
            if (game.keys['s']) {
                dx += Math.sin(player.rot) * speed;
                dz += Math.cos(player.rot) * speed;
            }
            if (game.keys['a']) {
                dx -= Math.cos(player.rot) * speed;
                dz += Math.sin(player.rot) * speed;
            }
            if (game.keys['d']) {
                dx += Math.cos(player.rot) * speed;
                dz -= Math.sin(player.rot) * speed;
            }

            // Collision
            const newX = player.x + dx;
            const newZ = player.z + dz;
            
            let canMove = true;
            const playerRadius = 25;
            
            for (let wall of walls) {
                const box = new THREE.Box3().setFromObject(wall);
                if (newX > box.min.x - playerRadius && newX < box.max.x + playerRadius &&
                    newZ > box.min.z - playerRadius && newZ < box.max.z + playerRadius) {
                    canMove = false;
                    break;
                }
            }
            
            for (let obj of interactables) {
                const box = new THREE.Box3().setFromObject(obj);
                if (newX > box.min.x - playerRadius && newX < box.max.x + playerRadius &&
                    newZ > box.min.z - playerRadius && newZ < box.max.z + playerRadius) {
                    canMove = false;
                    break;
                }
            }

            if (canMove) {
                player.x = newX;
                player.z = newZ;
                camera.position.x = player.x;
                camera.position.z = player.z;
            }

            // BPM Mechanics
            if (game.isRunning && (game.keys['w'] || game.keys['s'] || game.keys['a'] || game.keys['d'])) {
                game.bpm = Math.min(200, game.bpm + 0.4);
            } else {
                game.bpm = Math.max(60, game.bpm - 0.1);
            }

            // Calculate luck multiplier based on BPM
            game.luckMultiplier = 1 + ((game.bpm - 60) / 140) * 2;

            if (game.bpm >= 200) {
                overdose();
                return;
            }

            checkInteract();
            updateDisplay();
            drawHeart();
            renderer.render(scene, camera);
        }

        function checkInteract() {
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            
            const intersects = raycaster.intersectObjects(interactables);
            const interactDiv = document.getElementById('interaction');
            
            if (intersects.length > 0 && intersects[0].distance < 120) {
                const obj = intersects[0].object;
                game.nearObject = obj.userData.type;
                interactDiv.style.display = 'block';
                interactDiv.textContent = `PRESS E FOR ${obj.userData.name.toUpperCase()}`;
            } else {
                game.nearObject = null;
                interactDiv.style.display = 'none';
            }
        }

        function tryInteract() {
            if (!game.nearObject) return;
            
            switch(game.nearObject) {
                case 'lotto': buyTicket(); break;
                case 'slots': openSlots(); break;
                case 'cooler': openShop(); break;
                case 'case': openCase(); break;
                case 'pills': takePills(); break;
                case 'counter': showMessage("Cashier: 'Buy tickets at the pink machine! Get energy drinks at the cooler!'"); break;
            }
        }

        function showMessage(text) {
            const div = document.createElement('div');
            div.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:3px solid #ff006e;padding:30px;border-radius:15px;color:#fff;font-size:24px;z-index:5000;text-align:center;';
            div.textContent = text;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        function buyTicket() {
            if (game.cash < 10) { 
                showMessage("Need $10 for ticket!"); 
                return; 
            }
            game.cash -= 10;
            game.tickets++;
            updateDisplay();
            showTicket();
        }

        function showTicket() {
            document.exitPointerLock();
            const modal = document.getElementById('ticketModal');
            const area = document.getElementById('scratchArea');
            area.innerHTML = '';
            scratchedBoxes.clear();
            
            document.getElementById('luckIndicator').textContent = 
                `LUCK MULTIPLIER: ${game.luckMultiplier.toFixed(1)}x (BPM: ${Math.floor(game.bpm)})`;
            
            const baseValues = [1, 1, 2, 2, 5, 5, 10, 20, 50];
            let values = baseValues.map(v => Math.floor(v * game.luckMultiplier));
            
            for (let i = values.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [values[i], values[j]] = [values[j], values[i]];
            }
            
            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'scratch-box';
                box.dataset.index = i;
                box.dataset.value = values[i];
                box.innerHTML = `
                    <div class="scratch-cover">SCRATCH</div>
                    <div class="scratch-value">$${values[i]}</div>
                `;
                
                const cover = box.querySelector('.scratch-cover');
                
                cover.addEventListener('mousedown', () => isScratching = true);
                cover.addEventListener('mouseup', () => isScratching = false);
                cover.addEventListener('mouseleave', () => isScratching = false);
                
                cover.addEventListener('mousemove', function(e) {
                    if (isScratching && !box.classList.contains('scratched')) {
                        scratchBox(box, values[i]);
                    }
                });
                
                cover.addEventListener('click', function() {
                    if (!box.classList.contains('scratched')) {
                        scratchBox(box, values[i]);
                    }
                });
                
                area.appendChild(box);
            }
            
            modal.style.display = 'flex';
        }

        function scratchBox(box, value) {
            box.classList.add('scratched');
            scratchedBoxes.add(box.dataset.index);
            
            if (scratchedBoxes.size === 9) {
                setTimeout(checkWin, 600);
            }
        }

        function checkWin() {
            const boxes = document.querySelectorAll('.scratch-box');
            const values = Array.from(boxes).map(b => parseInt(b.dataset.value));
            const counts = {};
            values.forEach(v => counts[v] = (counts[v] || 0) + 1);
            
            let winAmount = 0;
            for (let v in counts) {
                if (counts[v] >= 3) {
                    winAmount = parseInt(v) * 10;
                    break;
                }
            }
            
            if (winAmount > 0) {
                game.cash += winAmount;
                showWinPopup(`üéâ WINNER! $${winAmount}! üéâ`);
            } else {
                showMessage('No match! Try again!');
            }
            updateDisplay();
        }

        function showWinPopup(text) {
            const popup = document.getElementById('winPopup');
            popup.textContent = text;
            popup.style.display = 'block';
            setTimeout(() => popup.style.display = 'none', 2000);
        }

        function closeTicket() {
            document.getElementById('ticketModal').style.display = 'none';
            isScratching = false;
            document.body.requestPointerLock();
        }

        function openSlots() {
            document.exitPointerLock();
            document.getElementById('slotsLuck').textContent = 
                `LUCK MULTIPLIER: ${game.luckMultiplier.toFixed(1)}x`;
            document.getElementById('slotsModal').style.display = 'flex';
        }

        function spinSlots() {
            if (game.cash < 50) {
                showMessage('Need $50!');
                return;
            }
            game.cash -= 50;
            updateDisplay();
            
            const reels = [document.getElementById('slot1'), 
                          document.getElementById('slot2'), 
                          document.getElementById('slot3')];
            
            reels.forEach(reel => reel.classList.add('spinning'));
            
            let results = [];
            
            setTimeout(() => {
                reels[0].classList.remove('spinning');
                results[0] = getSlotResult();
                reels[0].textContent = results[0];
            }, 1000);
            
            setTimeout(() => {
                reels[1].classList.remove('spinning');
                results[1] = getSlotResult();
                reels[1].textContent = results[1];
            }, 1500);
            
            setTimeout(() => {
                reels[2].classList.remove('spinning');
                results[2] = getSlotResult();
                reels[2].textContent = results[2];
                
                let win = 0;
                if (results[0] === results[1] && results[1] === results[2]) {
                    const multipliers = {'üçí': 5, 'üçã': 3, 'üíé': 20, '7Ô∏è‚É£': 50, 'üé∞': 100, 'üí∞': 10};
                    win = 50 * multipliers[results[0]] * game.luckMultiplier;
                } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
                    win = 25 * game.luckMultiplier;
                }
                
                if (win > 0) {
                    game.cash += Math.floor(win);
                    showWinPopup(`üé∞ JACKPOT! $${Math.floor(win)}!`);
                    updateDisplay();
                } else {
                    showMessage('No luck! Spin again!');
                }
            }, 2000);
        }

        function getSlotResult() {
            const rand = Math.random();
            if (game.bpm > 150 && rand < 0.3) return '7Ô∏è‚É£';
            if (game.bpm > 120 && rand < 0.4) return 'üíé';
            if (rand < 0.5) return 'üçí';
            if (rand < 0.7) return 'üçã';
            if (rand < 0.85) return 'üí∞';
            return 'üé∞';
        }

        function closeSlots() {
            document.getElementById('slotsModal').style.display = 'none';
            document.body.requestPointerLock();
        }

        function openShop() {
            document.exitPointerLock();
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            
            const items = [
                {name:'Coffee', price:5, bpm:15, desc:'Basic caffeine boost'},
                {name:'Energy Drink', price:25, bpm:35, desc:'Sugar rush!'},
                {name:'Monster Energy', price:60, bpm:60, desc:'MAXIMUM POWER'},
                {name:'Adrenaline Shot', price:150, bpm:100, desc:'DANGER: HIGH BPM'},
                {name:'Bandage', price:30, bpm:-40, desc:'Slow down heart'}
            ];
            
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item-btn';
                if (game.cash < item.price) div.classList.add('disabled');
                
                div.innerHTML = `
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-price">$${item.price}</div>
                    <div class="shop-item-effect">${item.bpm > 0 ? '+' : ''}${item.bpm} BPM</div>
                    <div style="color:#888;font-size:14px;margin-top:5px;">${item.desc}</div>
                `;
                
                div.onclick = () => {
                    if (game.cash >= item.price) {
                        game.cash -= item.price;
                        game.bpm = Math.max(60, Math.min(200, game.bpm + item.bpm));
                        updateDisplay();
                        openShop();
                        showMessage(`${item.name} consumed! BPM ${item.bpm > 0 ? '‚Üë' : '‚Üì'}`);
                    }
                };
                grid.appendChild(div);
            });
            
            document.getElementById('shopModal').style.display = 'flex';
        }

        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
            document.body.requestPointerLock();
        }

        function openCase() {
            document.exitPointerLock();
            document.getElementById('caseLuck').textContent = 
                `LUCK MULTIPLIER: ${game.luckMultiplier.toFixed(1)}x`;
            document.getElementById('caseModal').style.display = 'flex';
        }

        function spinCase() {
            if (game.cash < 100) { 
                showMessage('Need $100!'); 
                return; 
            }
            game.cash -= 100;
            updateDisplay();
            
            const roulette = document.getElementById('caseRoulette');
            roulette.innerHTML = '';
            roulette.style.left = '50%';
            
            const items = [
                {name:'Trash', val:5, cls:'common', weight: 30},
                {name:'Junk', val:15, cls:'common', weight: 25},
                {name:'Old Phone', val:80, cls:'uncommon', weight: 20},
                {name:'Watch', val:200, cls:'rare', weight: 15},
                {name:'Gaming PC', val:800, cls:'epic', weight: 8},
                {name:'Sports Car', val:5000, cls:'legendary', weight: 2}
            ];
            
            if (game.bpm > 140) {
                items.forEach(i => {
                    if (i.cls === 'legendary' || i.cls === 'epic') i.weight *= 2;
                });
            }
            
            const caseItems = [];
            for (let i = 0; i < 30; i++) {
                const r = Math.random() * 100;
                let cumWeight = 0;
                let selected = items[0];
                
                for (let item of items) {
                    cumWeight += item.weight;
                    if (r <= cumWeight) {
                        selected = item;
                        break;
                    }
                }
                
                caseItems.push(selected);
                const div = document.createElement('div');
                div.className = `case-item ${selected.cls}`;
                div.innerHTML = `
                    <div style="font-size:50px;">${selected.val >= 500 ? 'üíé' : selected.val >= 100 ? 'üí∞' : 'üì¶'}</div>
                    <div style="font-weight:bold;">${selected.name}</div>
                    <div style="color:#0f0;font-weight:bold;">$${selected.val}</div>
                `;
                roulette.appendChild(div);
            }
            
            setTimeout(() => {
                const offset = -(15 * 195) + 360;
                roulette.style.left = `calc(50% + ${offset}px)`;
                
                setTimeout(() => {
                    const win = caseItems[15];
                    const winAmount = Math.floor(win.val * game.luckMultiplier);
                    game.cash += winAmount;
                    showWinPopup(`üéâ ${win.name}! $${winAmount}! üéâ`);
                    updateDisplay();
                }, 4000);
            }, 100);
        }

        function closeCase() {
            document.getElementById('caseModal').style.display = 'none';
            document.body.requestPointerLock();
        }

        function takePills() {
            if (game.cash < 50) { 
                showMessage('Need $50!'); 
                return; 
            }
            game.cash -= 50;
            game.bpm += 30;
            updateDisplay();
            showMessage('üíä BPM +30! Feeling lucky...');
        }

        function overdose() {
            game.isDead = true;
            document.exitPointerLock();
            const screen = document.getElementById('overdoseScreen');
            screen.style.display = 'flex';
            
            let timer = 3;
            const timerDiv = document.getElementById('deathTimer');
            
            const interval = setInterval(() => {
                timer--;
                timerDiv.textContent = timer;
                if (timer <= 0) {
                    clearInterval(interval);
                    respawn();
                }
            }, 1000);
        }

        function respawn() {
            game.isDead = false;
            game.bpm = 60;
            game.cash = Math.floor(game.cash / 2);
            player.x = 0;
            player.z = 200;
            camera.position.x = player.x;
            camera.position.z = player.z;
            
            document.getElementById('overdoseScreen').style.display = 'none';
            document.body.requestPointerLock();
            updateDisplay();
            showMessage('RESPAWNED! Lost half your cash...');
        }

        function updateDisplay() {
            document.getElementById('cashDisplay').textContent = game.cash;
            document.getElementById('debtDisplay').textContent = game.debt;
            document.getElementById('bpmDisplay').textContent = Math.floor(game.bpm);
            document.getElementById('bpmText').textContent = Math.floor(game.bpm) + ' BPM';
            document.getElementById('ticketDisplay').textContent = game.tickets;
            
            const bpmDisplay = document.querySelector('.stat-bpm');
            if (game.bpm > 160) {
                bpmDisplay.style.color = '#ff0000';
                bpmDisplay.style.textShadow = '0 0 20px rgba(255,0,0,1)';
            } else if (game.bpm > 120) {
                bpmDisplay.style.color = '#ff8800';
                bpmDisplay.style.textShadow = '0 0 15px rgba(255,136,0,0.8)';
            } else {
                bpmDisplay.style.color = '#ffbe0b';
                bpmDisplay.style.textShadow = '0 0 15px rgba(255,190,11,0.8)';
            }
        }

        function drawHeart() {
            const c = document.getElementById('heartCanvas');
            const ctx = c.getContext('2d');
            const w = c.width = c.offsetWidth;
            const h = c.height = c.offsetHeight;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            let color = '#0f0';
            if (game.bpm > 120) color = '#ff0';
            if (game.bpm > 160) color = '#f00';
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 10;
            ctx.shadowColor = color;
            ctx.beginPath();
            
            const speed = 60000 / game.bpm;
            const t = Date.now() / speed;
            
            for (let i = 0; i < w; i++) {
                const x = (i / w) * Math.PI * 4;
                const y = h/2 + Math.sin(x + t * 10) * (h/3) * Math.exp(-((x % (Math.PI*2)) - Math.PI)**2);
                if (i === 0) ctx.moveTo(i, y);
                else ctx.lineTo(i, y);
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }
    </script>
</body>
</html>
